# Rogue Web 実装タスクリスト

## 重要: 参考ソース、リポジトリ
実装に迷ったり、仕様を確認したい場合は必ず以下を参照すること。
オリジナルソースファイル
C:\_Personal\作成物\趣味\rogue-reference\src
**https://github.com/suzukiiichiro/Rogue2.Official**


---

## 現在の実装状況 (2026/01/13 更新)

### 最新の追加機能 (本日実装)
*   **武器・防具の識別システム (オリジナルRogue準拠)**:
    *   **防具**: 装備した瞬間に識別される (`pack.c wear/do_wear`)
    *   **武器**: 識別の巻物を使うまでエンチャント値が不明
    *   **初期装備**: 最初から識別済み
    *   **表示**: 識別されていない武器はエンチャント値を表示しない
*   **エンチャント値の正しい反映**:
    *   **防具AC計算**: 基本AC + エンチャント値 (`damageBonus`)
    *   **武器命中率**: `hitBonus` を反映
    *   **武器ダメージ**: `damageBonus` を反映
    *   **器用さの指輪**: 命中率に反映 (`ring_exp * 3`)
    *   **錆び**: エンチャント値(`damageBonus`)を減らす
*   **浮遊状態の完全実装 (オリジナルRogue準拠)**:
    *   **罠無効**: 浮遊中は罠を踏まない (既存)
    *   **拘束無効**: 浮遊中は拘束攻撃を受けない (新規)
    *   **階段制限**: 浮遊中は階段を降りられない (新規)
    *   **アイテム制限**: 浮遊中はアイテムを拾えない (新規)
*   **デバッグレベル改善**:
    *   **探索機能**: デバッグレベルでも休息・探索が可能に (`search`メソッドをオーバーライド)
*   **地図作成の巻物 (Magic Mapping)**:
    *   マップ公開時に「罠」も表示されるように修正 (オリジナルRogue準拠)
*   **錆び処理の完全化**:
    *   **AC制限**: ACが1以下の場合は錆びない仕様を実装 (オリジナルRogue準拠)
    *   **罠統一**: 錆びの罠もモンスター攻撃と同じロジックを使用するように修正 (革の鎧や保護状態を正しく判定)
*   **移動・ダッシュの挙動修正**:
    *   **部屋判定**: 部屋への入退室判定を「部屋ID変化」から「ドア通過時」に変更 (オリジナルRogue準拠)
    *   **ダッシュ停止**: ドアによるダッシュ停止判定を「上下左右のみ」に限定 (斜め移動時は止まらない)
*   **UI/表示改善**:
    *   **未識別名**: 指輪装備時のメッセージで未識別名が正しく表示されるように修正
    *   **保護マーク**: 保護された防具にはインベントリで `*` マークを表示 (ユーザー要望)
*   **罠システムの完全化 (オリジナルRogue準拠)**:
    *   **落とし穴 (TRAP_DOOR)**: ダメージなしで次の階層へ移動。浮遊時は発動しない仕様を実装
    *   **熊の罠 (BEAR_TRAP)**: 毎ターン拘束時間が減少するように修正（移動以外の行動は可能に）
    *   **毒ダーツ (DART_TRAP)**: **力維持の指輪**による毒効果無効化を実装
    *   **睡眠ガス (SLEEPING_GAS_TRAP)**:
        *   ターン経過の実装を一新（`procceTurn`ループから非同期のウェイト処理へ）
        *   メッセージ表示とウェイトの順序を最適化し、状況をわかりやすく改善
        *   死亡時に不自然なメッセージ（「目が覚めた」）が出ないように修正
    *   **テレポート (TELE_TRAP)**: ランダム移動の実装を確認（正常）
    *   **錆び罠 (RUST_TRAP)**: 特殊攻撃ロジックに統合済み
*   **モンスターハウス (Party Room) 実装完了 (オリジナルRogue準拠)**:
    *   **発生ロジック**: 10階ごとのブロック（11-20, 21-30...）内でランダムに1回発生（最速11階）
    *   **配置処理**: ランダムな部屋に大量のアイテム（5-15個）とモンスター（アイテム数の2倍）を配置
    *   **起床処理**: 部屋に入ると75%の確率でモンスターが一斉に目覚める（WAKENSフラグ）
    *   **座標計算**: 部屋の壁の内側（`left_col+1` ~ `right_col-1`）に正しく配置
    *   **バグ修正**: アイテム・モンスター生成、床判定、処理順序など複数のバグを修正
*   **モンスター挙動の完全化**:
    *   **起床判定**: 部屋から出る際にもモンスターが起きるように修正 (オリジナルRogue準拠)
    *   **初期状態**: 徘徨性モンスターは50%の確率で最初から起きているように修正 (オリジナルRogue準拠)


### 前回の追加機能 (2026/01/08)
*   **モンスターAI修正**:
    *   **部屋での追跡**: 部屋に入った際にターゲットを見失わないように修正（壁判定の改善）
    *   **生成ロジック**: 時間経過で湧くモンスターがドアの上に生成されないように修正
    *   **行動ルール**: 寝ているモンスターが起きた直後のターンには攻撃しないように修正（オリジナル準拠）
*   **デバッグ機能**:
    *   **AI状態表示**: [C]hase/[S]eek/[W]ander を表示して行動ロジックを可視化
*   **バグ修正**:
    *   **食料**: 空腹度が正しく回復するように修正
    *   **配置**: ドアの上にアイテム・モンスターが生成されないように修正
    *   **ダンジョン生成**: 孤立した部屋が生成されないように接続アルゴリズムを改善
*   **階層移動システム**:
    *   階段を降りて次の階層へ進める機能を実装
    *   プレイヤーの状態（HP、持ち物、経験値）が引き継がれる
*   **メッセージシステム**:
    *   **mesg_J.js作成**: オリジナルRogueの全493個のメッセージを配列化
    *   **mesg_J.js作成**: オリジナルRogueの全493個のメッセージを配列化
    *   **全メッセージ移行**: 戦闘、移動、アイテム、罠、特殊攻撃など全メッセージをmesg_J準拠に統一
*   **識別の巻物 (Identify)**:
    *   **選択UI実装**: 巻物使用後にアイテムを選択して識別するフローを実装 (オリジナルRogue準拠)
    *   **UI改善**: 識別モード時のカーソル色変更(黄色)、キャンセル挙動の修正
*   **怪物に恐怖をもたらす巻物 (Scare Monster)**:
    *   **効果実装**: 足元に置いたアイテムの上にはモンスターが侵入できない仕様を実装
    *   **挙動**: プレイヤーが乗っても効果あり。再ピックアップ時に塵となる処理も実装

### 🏆 ゲームクリア・ランキングシステム (本日実装)
*   **クリア画面 (Victory)**:
    *   オリジナルRogue準拠のAAバナーを表示
    *   アイテム売却画面とスコア計算処理を実装
*   **ランキング・墓石 (Score)**:
    *   死亡時の墓石表示（AA）、ゲームクリア/死亡時のランキング表示（Top 10）
    *   再プレイ機能のバグ修正（DOM操作の改善）
*   **UI/UX改善**:
    *   **操作統一**: 全画面で「Aボタン（Zキー）」による進行が可能に
    *   **表示統一**: フォントサイズを1.2remに統一し、可読性向上
    *   **インベントリ**: 開いた際のカーソル位置を常に先頭に固定
    *   **デバッグ**: クリア時にデバッグモードを自動OFFにする機能追加
    *   **デバッグ移動**: `,` `.` キーによる強制階層移動（デバッグモード時）を実装
    *   **魔除け**: 26階以降での確定生成ロジックを実装
    *   **アイテム生成**: 帰還時（到達済み階層への移動）のアイテム生成を抑制（オリジナル準拠）

### 🟢 完了・実装済み（オリジナルRogue準拠）
*   **モンスターデータ**: 全26種 (HP, Exp, Level, Damage)
*   **モンスターAI**: `mon_sees()` 完全移植。部屋/隣接判定、斜め移動対応
*   **戦闘システム**: `hit.c` / `fight.c` 完全移植（命中、ダメージ、STR/武器補正）
*   **投擲システム**: `throw.c` 準拠（軌道計算、弓矢ボーナス）。外れたら落ちる処理も実装
*   **アイテム操作**:
    *   **拾う/使う/置く/投げる**: 基本動作実装済み
    *   **ポーション**: `use.c` 完全移植（全12種類、画面・ゲーム効果含む）
    *   **巻物**: `use.c` 完全移植（全12種類、怪物召喚含む）
    *   **杖 (Wand)**: `zap.c` ほぼ移植完了（詳細な効果実装済み）
    *   **指輪 (Ring)**: `ring.c` データ移植完了（装備/解除UI含む）
    *   **スタック処理**: `pack.c` 準拠（矢などのスタック、武器の一括ドロップ、薬の個別ドロップ）
*   **アイテムデータ**: 武器、防具、薬、巻物、食料、杖、指輪の定義と識別名生成
*   **デバッグ環境**: デバッグレベル、アイテム配置、詳細ステータス表示、ゲーム中デバッグモード
*   **ダンジョン・視界**: 3x3グリッド生成、視界透過処理、孤立部屋の修正
*   **空腹度**: 減算と状態変化、回復
*   **罠 (Trap)**: `trap.c` 完全実装（全6種類、浮遊時無効化）
*   **階層移動**: 階段を降りて次の階層へ進める。プレイヤーの状態（HP、持ち物、経験値）が引き継がれる
*   **拡張機能**:
    *   **ポーション投擲**: 敵にポーションを投げると効果（毒でダメージ、混乱で混乱など）
    *   **杖投擲**: 杖を投げると75%の確率で効果発動
    *   **識別挙動改善**: アイテムを使ったら必ず識別される
    *   **指輪UI改善**: 左右選択と自動入れ替え機能
*   **アイテム表示改善**:
    *   **呪いの表示**: 識別済みの呪われたアイテムに `!` マーク + 赤色表示
    *   **エンチャント値**: 武器・防具・指輪のエンチャント値を表示（オリジナルRogue準拠）
    *   **色分け**: プラスのエンチャント（黄色）、呪い（赤色）、通常（緑色）
*   **生成ロジック調整**:
    *   **モンスター配置**: 必ず4〜6体生成されるよう修正
    *   **アイテム頻度**: オリジナルの出現確率（薬・巻物30%など）に調整
    *   **金貨**: 各部屋46%の確率で、階層に応じた金額を生成
    *   **初期装備**: メイス(+1,+1)、リングメイル(+1)、弓(+1,+0)、矢(25-35本)に修正
*   **インベントリUI改善**:
    *   **並び順**: 武器 > 防具 > 指輪 > 食料の順にソート
    *   **表示形式**: `a) EL ! 長い剣 (+1, +1)` のように固定幅で整列
    *   **エンチャント**: 値が0の場合は非表示、名前の後ろに移動

### 改善・検討が必要な点
*   **迷路と通路が隣接する問題**: オリジナルRogueでも発生する仕様だが、通路が迷路の境界のすぐ横を通ると、迷路にドアを通らずに入れてしまう。オリジナル準拠のため現状維持だが、将来的に改善を検討。
*   **指輪の入れ替え仕様**: 現在は自動入れ替え（拡張版）。オリジナル準拠（外してから装備）にするか、2ターン消費にするか検討中
*   **スタック武器のエンチャント**: 現在は矢などのスタック武器もエンチャントされるが、オリジナルでは`quiver`値で別管理。JS版では簡略化してスタック武器はエンチャントなしにするか検討中
*   **こけももの名前設定**: 現在は固定名「こけもも」。オリジナル準拠で「好きな果物」を設定できる機能を追加するか検討中
*   **MAGIC_MISSILE の軌道表示**: アニメーション (一括表示)
*   **ダンジョン生成の厳密化**: オリジナルRogueの `connect` や `do_passages` のロジックをより厳密に再現し、通路形状を最適化する。


### 🔴 未実装(不要)
*   **セーブ/ロード**: `save.c`
*   **スコア**: `score.c`

---

## 完了済みタスク (Recent)

### 2026-01-09
- [x] **SCARE_MONSTER実装**: 足元に置いた場合のモンスター侵入不可、再取得時の消滅
- [x] **識別の巻物完全化**: 使用後のアイテム選択UI、メッセージ順序、キャンセル挙動、消費後の再描画修正
- [x] **DebugLevel修正**: 隠しオブジェクトの初期化漏れ修正、視界処理の改善
- [x] **メッセージ表示改善**:
    - [x] ログの高さ不足による見切れ修正
    - [x] 同一ターンのメッセージを白文字で維持するよう修正
    - [x] レベルアップメッセージの順序と内容をオリジナル準拠(HP表示削除など)に修正
    - [x] 薬使用時のメッセージ順序修正

### 2026-01-08
- [x] **モンスターAI改善**: 通路での追跡、行き止まりでの引き返し、視界判定の強化
- [x] **バグ修正**: 休息/探索時の2重ターン消費、階層移動時の感知ステータスリセット
- [x] **ポーション完全実装**: オリジナル準拠の効果時間、毒メッセージ、透明視の永続化など
- [x] **杖修正**: 無効化の杖(CANCELLATION)の挙動をオリジナルに合わせる(特殊能力解除)
- [x] **こけもも実装**: 食料アイテムの分割
- [x] **モンスター攻撃修正**: ドアや壁角越し(斜め)の攻撃を不可にする(canMove判定追加)

---

## ポーション (Potion) 実装状況詳細 (potion_status_check.md より統合)

### ✅ 完全実装済み (use.c 準拠)
1.  **強さが増す水薬 (INCREASE_STRENGTH)**: 筋力増加
2.  **強さが元にもどる水薬 (RESTORE_STRENGTH)**: 筋力回復
3.  **体力が回復する水薬 (HEALING)**: HP回復 (小)
4.  **体力がとても回復する水薬 (EXTRA_HEALING)**: HP回復 (大) + 最大HP増加
5.  **毒の水薬 (POISON)**: 筋力減少 + 幻覚治癒
6.  **経験が増す水薬 (RAISE_LEVEL)**: レベルアップ
7.  **頭が混乱する水薬 (CONFUSION)**: 混乱付与
8.  **空中に浮きあがる水薬 (LEVITATION)**: 浮遊付与 (罠回避)
9.  **素早くなる水薬 (HASTE_SELF)**: 加速付与 (2回行動)
10. **遠くの怪物がわかる水薬 (DETECT_MONSTER)**: モンスター感知 (階層移動で解除)
11. **遠くのものがわかる水薬 (DETECT_OBJECTS)**: アイテム感知 (階層移動で解除)
12. **見えないものが見える水薬 (SEE_INVISIBLE)**: 透明視認、盲目治癒 (こけももジュース味、永続)
13. **目が見えなくなる水薬 (BLINDNESS)**: 盲目付与 (500-800ターン)
14. **幻覚をおこす水薬 (HALLUCINATION)**: 幻覚付与 (500-800ターン)

---

## 杖 (Wand) 実装状況詳細 (wand_status_check.md より統合)

### ✅ 完全実装済み (zap.c 準拠) - 全10種類
1.  **テレポートの杖 (TELE_AWAY)**: モンスターを飛ばす
2.  **鈍化の杖 (SLOW_MONSTER)**: 速度低下
3.  **混乱の杖 (CONFUSE_MONSTER)**: ランダム移動
4.  **透明化の杖 (INVISIBILITY)**: 透明化
5.  **変身の杖 (POLYMORPH)**: 別モンスターに変化
6.  **加速の杖 (HASTE_MONSTER)**: 速度上昇
7.  **睡眠の杖 (PUT_TO_SLEEP)**: 睡眠付与
8.  **魔法の矢の杖 (MAGIC_MISSILE)**: ダメージ
9.  **無効化の杖 (CANCELLATION)**: 特殊能力解除
10. **何もしない杖 (DO_NOTHING)**: その名の通り


---

## 巻物 (Scroll) 実装状況詳細 (scroll_status_check.md より統合)

### ✅ 完全実装済み (use.c 準拠)
1.  **識別の巻物 (IDENTIFY)**: 使用後に対象を選択して識別 (キャンセル時は消費のみ)
2.  **テレポートの巻物 (TELEPORT)**: ランダムテレポート
3.  **武器強化の巻物 (ENCH_WEAPON)**: 命中/ダメージ強化、解呪
4.  **防具強化の巻物 (ENCH_ARMOR)**: AC強化、解呪
5.  **防具保護の巻物 (PROTECT_ARMOR)**: 錆び防止、解呪
6.  **呪い解除の巻物 (REMOVE_CURSE)**: 全アイテム解呪
7.  **睡眠の巻物 (SLEEP)**: プレイヤー睡眠状態 (4-8ターン)
8.  **地図作成の巻物 (MAGIC_MAPPING)**: 全マップ公開
9.  **怪物恐怖の巻物 (SCARE_MONSTER)**: 足元に置くとモンスターが侵入できない。拾うと消滅。
10. **怪物召喚の巻物 (CREATE_MONSTER)**: プレイヤー周囲にモンスター生成
11. **金縛りの巻物 (HOLD_MONSTER)**: 周囲2マスのモンスターをASLEEP停止
12. **怪物激怒の巻物 (AGGRAVATE_MONSTER)**: 全モンスター起床、擬態解除

---

## 参考資料: オリジナル仕様メモ

### 1. CREATE_MONSTER (怪物召喚)
**オリジナルの処理 (monster.c line 580-616)**:
- プレイヤー周囲9マスをランダムに探索
- 配置可能な場所 (床・通路・階段・ドア) にモンスターを生成
- 生成されたモンスターは即座に起きる (WAKENS)

### 2. HOLD_MONSTER (金縛り)
**オリジナルの処理 (use.c line 637-667)**:
- プレイヤー周囲5x5マス (2マス範囲) のモンスター対象
- フラグ `ASLEEP` を立て、`WAKENS` を解除する (起きなくなる)

### 3. AGGRAVATE_MONSTER (怪物激怒)
**オリジナルの処理 (monster.c line 738-753)**:
- 全モンスターを `wake_up`
- `IMITATES` フラグを解除 (MimicやXerocが正体を現す)
- 視界内のモンスターを再描画

### 4. 探索と隠し要素 (`search.c`)
- [x] 基本的な探索コマンドの実装 (`s` キー)
    - [x] `Level.js` に `search` メソッド実装
    - [x] `Game.js` に `search` コマンド処理追加
- [x] 隠し扉 (`HIDDEN_DOOR`) の実装
    - [x] マップ生成時に確率で隠し扉を作成
    - [x] 探索で発見したら通常の扉 (`+`) に変化
- [x] 隠し通路 (`HIDDEN_PASSAGE`) の実装 - *Level.jsのhiddenObjectsで対応済み*
- [x] 罠の探索 - *TrapManager.searchで実装済み*

### 5. UI/UX 改善
*   [x] ゲーム中デバッグモード（壁無視、全体表示、モンスター全表示）
*   [x] サブメニュー位置調整（インベントリパネルに合わせて配置）
*   [x] 死亡時の確認待ち（メッセージ表示後、Aボタンで墓石へ）
*   [ ] メッセージ履歴のログ表示機能
*   [ ] キーボード操作の完全化（viキーバインドなどの調整）

---

## モンスターAIと特殊能力
### 実装状況詳細 (monster_status_check.md より統合)

#### ✅ 実装済み
1. **基本AI**:
    - [x] プレイヤー追跡 (視界外追跡 trow/tcol 実装済み)
    - [x] 起床判定 (wake_room 準拠: 入室時・隣接時・被ダメ時のみ)
    - [x] 斜め移動・ターゲット更新
2. **特殊攻撃 (spechit.c)**:
    - [x] 錆び攻撃 (Rust Armor - Aquator)
    - [x] 毒攻撃 (Sting - Rattlesnake)
    - [x] 生命力吸収 (Drain Life MaxHP - Vampire)
    - [x] 吸精 (Drop Level - Wraith)
    - [x] 盗み (Steal Gold/Item - Leprechaun, Nymph)
    - [x] 凍結 (Freeze - Ice Monster)
    - [x] 締め付け (Hold - Venus Flytrap)
3. **行動パターン**:
    - [x] **HASTED/SLOWED**: 行動回数反映 (2回行動/スキップ)
    - [x] **CONFUSED**: ランダム移動
    - [x] **NAPPING**: 睡眠カウントダウンと起床
    - [x] **FLIES**: 距離がある場合は2倍移動、罠回避
    - [x] **FLITS**: 47%でランダム移動 (Bat等)
    - [x] **STATIONARY**: 移動しない (Flytrap/Fungi)
    - [x] **AGGRAVATE**: 全モンスター起床、擬態解除
4. **特殊行動**:
    - [x] **CONFUSES (Medusa)**: 攻撃ヒット時に確率で混乱
    - [x] **FLAMES (Dragon)**: 射程7マスの炎攻撃 (AC軽減無視、必中ではない)
    - [x] **SEEKS_GOLD (Leprechaun)**: 金貨への移動優先 (未実装: 盗んで消える処理) 

### 未実装・調整中
- [ ] **SEEKS_GOLD**: 金貨を盗んだ後の逃走ロジック
- [ ] **迷路 (Maze)**: オリジナルRogue準拠の迷路生成

---


## オリジナルソースコード移植状況 (rogue-reference/src)

| ファイル | 内容 | 状況 | 備考 |
| :--- | :--- | :--- | :--- |
| `monster.c` | モンスターAI | ✅ 完了 | 完全移植 (視界判定 `isLineOfSight` 実装済み) |
| `init.c` | 初期化・生成 | ✅ 完了 | 完全移植 (時間経過湧き `spawnWanderingMonster` 実装済み) |
| `random.c` | 乱数生成 | ✅ 完了 | 完全移植 (`js/random.js` 32bit互換実装) |
| `object.c` | アイテム定義 | ✅ 完了 | 完全移植 |
| `throw.c` | 投擲 | ✅ 完了 | 完全移植 |
| `hit.c` / `fight.c` | 戦闘 | ✅ 完了 | 完全移植 |
| `zap.c` | 杖 | ✅ 完了 | 効果実装済み |
| `pack.c` | インベントリ | ✅ 完了 | スタック処理実装済み |
| `move.c` | 移動 | ✅ 完了 | 完全移植 (`one_move_rogue`, `multiple_move_rogue`, 斜め制限) |
| `play.c` | ゲーム進行 | ✅ 完了 | レベルアップ処理(XPテーブル, HP上昇) 準拠 |
| `use.c` | アイテム効果 | ✅ 完了 | ポーション・巻物全実装 |
| `ring.c` | 指輪 | 🚧 作業中 | 効果計算ロジック連携待ち |
| `trap.c` | 罠 | ✅ 完了 | 基本実装済み |
| `spechit.c` | 特殊攻撃 | ✅ 完了 | 実装済み |
| `save.c` | セーブ | ❌ 未対応 | 不要 |
| `score.c` | スコア | ✅ 完了 | ランキング表示, 墓石, 勝利画面実装済み |
| `search.c` | 探索 | ✅ 完了 | searchコマンド実装済み |

