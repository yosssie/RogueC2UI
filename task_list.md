# Rogue Web 実装タスクリスト

## 重要: 参考リポジトリ
実装に迷ったり、仕様を確認したい場合は必ず以下を参照すること。
**https://github.com/suzukiiichiro/Rogue2.Official**
(特に `src/monster.c`, `src/init.c`, `src/fight.c` など)

---

## 現在の実装状況 (2026/01/07 更新)

### 最新の追加機能 (本日実装)
*   **ポーション完全実装**: use.c 準拠で全12種類の効果を完全実装
    *   回復薬の複雑なロジック (HP割合計算、状態異常治癒)
    *   全ての画面効果 (盲目、幻覚、モンスター感知、アイテム感知)
    *   全てのゲーム効果 (混乱、加速、浮遊)
*   **巻物完全実装**: use.c 準拠で全12種類の効果を完全実装
    *   怪物召喚 (CREATE_MONSTER) - プレイヤー周囲にランダムモンスター生成
    *   金縛り (HOLD_MONSTER) - 範囲拡大、メッセージ改善
    *   怪物激怒 (AGGRAVATE_MONSTER) - IMITATES解除

### 🟢 完了・実装済み（オリジナルRogue準拠）
*   **モンスターデータ**: 全26種 (HP, Exp, Level, Damage)
*   **モンスターAI**: `mon_sees()` 完全移植。部屋/隣接判定、斜め移動対応
*   **戦闘システム**: `hit.c` / `fight.c` 完全移植（命中、ダメージ、STR/武器補正）
*   **投擲システム**: `throw.c` 準拠（軌道計算、弓矢ボーナス）。外れたら落ちる処理も実装
*   **アイテム操作**:
    *   **拾う/使う/置く/投げる**: 基本動作実装済み
    *   **ポーション**: `use.c` 完全移植（全12種類、画面・ゲーム効果含む）
    *   **巻物**: `use.c` 完全移植（全12種類、怪物召喚含む）
    *   **杖 (Wand)**: `zap.c` ほぼ移植完了（詳細な効果実装済み）
    *   **指輪 (Ring)**: `ring.c` データ移植完了（装備/解除UI含む）
    *   **スタック処理**: `pack.c` 準拠（矢などのスタック、武器の一括ドロップ、薬の個別ドロップ）
*   **アイテムデータ**: 武器、防具、薬、巻物、食料、杖、指輪の定義と識別名生成
*   **デバッグ環境**: デバッグレベル、アイテム配置、詳細ステータス表示、ゲーム中デバッグモード
*   **ダンジョン・視界**: 3x3グリッド生成、視界透過処理
*   **空腹度**: 減算と状態変化、回復
*   **罠 (Trap)**: `trap.c` 完全実装（全6種類、浮遊時無効化）

### 🟡 簡易実装・調整中
*   **探索 (Search)**: `s`キー探索（隠し扉発見など）は未実装

### 🔴 未実装
*   **杖の追加効果**: 照明 (Light), 生命力吸収 (Drain Life), 属性攻撃 (Cold/Fire/Lightning/Striking)
*   **モンスター速度の行動回数反映**: Hasted/Slowedモンスターの行動回数調整
*   **セーブ/ロード**: `save.c`
*   **スコア**: `score.c`
*   **階層移動時の保持**: 現状は階段を降りると完全に新しいレベルになる

---

## 次の優先タスク

1. **杖の追加効果** - Light, Drain Life, Cold, Fire, Lightning, Striking
2. **モンスター速度の行動回数反映** - Hasted/Slowedモンスターの処理
3. **探索と隠し要素** - 隠し扉/隠し通路の生成と探索コマンド

---


## ポーション (Potion) 実装状況詳細 (potion_status_check.md より統合)

### ✅ 完全実装済み (use.c 準拠)
1.  **強さが増す水薬 (INCREASE_STRENGTH)**: 筋力増加
2.  **強さが元にもどる水薬 (RESTORE_STRENGTH)**: 筋力回復
3.  **体力が回復する水薬 (HEALING)**: HP回復 (小)
4.  **体力がとても回復する水薬 (EXTRA_HEALING)**: HP回復 (大) + 最大HP増加
5.  **毒の水薬 (POISON)**: 筋力減少
6.  **経験が増す水薬 (RAISE_LEVEL)**: レベルアップ
7.  **頭が混乱する水薬 (CONFUSION)**: 混乱付与
8.  **空中に浮きあがる水薬 (LEVITATION)**: 浮遊付与 (罠回避)
9.  **素早くなる水薬 (HASTE_SELF)**: 加速付与 (2回行動)
10. **遠くの怪物がわかる水薬 (DETECT_MONSTER)**: モンスター感知
11. **遠くのものがわかる水薬 (DETECT_OBJECTS)**: アイテム感知
12. **見えないものが見える水薬 (SEE_INVISIBLE)**: 透明視認、盲目治癒
13. **目が見えなくなる水薬 (BLINDNESS)**: 盲目付与 (画面効果は未実装部分あり)
14. **幻覚をおこす水薬 (HALLUCINATION)**: 幻覚付与 (画面効果は未実装部分あり)

### 実装が必要な画面効果
- [ ] **盲目 (BLINDNESS)**: 画面が真っ暗になる (現在はフラグのみ)
- [ ] **幻覚 (HALLUCINATION)**: シンボルがランダムに変わる (現在はフラグのみ)
- [ ] **モンスター感知**: モンスター全表示 (現在はマップ表示のみ)

---

## 杖 (Wand) 実装状況詳細 (wand_status_check.md より統合)

### ✅ 完全実装済み (zap.c 準拠) - 全10種類
1.  **テレポートの杖 (TELE_AWAY)**: モンスターを飛ばす
2.  **鈍化の杖 (SLOW_MONSTER)**: 速度低下
3.  **混乱の杖 (CONFUSE_MONSTER)**: ランダム移動
4.  **透明化の杖 (INVISIBILITY)**: 透明化
5.  **変身の杖 (POLYMORPH)**: 別モンスターに変化
6.  **加速の杖 (HASTE_MONSTER)**: 速度上昇
7.  **睡眠の杖 (PUT_TO_SLEEP)**: 睡眠付与
8.  **魔法の矢の杖 (MAGIC_MISSILE)**: ダメージ (軌道表示は未実装)
9.  **無効化の杖 (CANCELLATION)**: 特殊能力解除
10. **何もしない杖 (DO_NOTHING)**: その名の通り

### 📝 重要な仕様確認
**以下の杖はオリジナルRogueには存在しません:**
*   Light
*   Drain Life
*   Cold
*   Fire
*   Lightning
*   Striking
これらはNetHackや他のバリアント由来のものです。

### 改善が必要な点
- [ ] **MAGIC_MISSILE の軌道表示**: アニメーション
- [ ] **CANCELLATION の完全実装**: 全特殊能力フラグの解除

## モンスターAIと特殊能力
### 実装状況詳細 (monster_status_check.md より統合)

#### ✅ 実装済み
1. **基本AI**: プレイヤー追跡、部屋・通路の認識、斜め移動
2. **特殊攻撃 (spechit.c)**:
    - [x] 錆び攻撃 (Rust Armor - Aquator)
    - [x] 毒攻撃 (Sting - Rattlesnake)
    - [x] 生命力吸収 (Drain Life MaxHP - Vampire)
    - [x] 吸精 (Drop Level - Wraith)
    - [x] 盗み (Steal Gold/Item - Leprechaun, Nymph)
    - [x] 凍結 (Freeze - Ice Monster)
    - [x] 締め付け (Hold - Venus Flytrap)
3. **行動パターン**:
    - [x] **HASTED/SLOWED**: 行動回数反映 (2回行動/スキップ)
    - [x] **CONFUSED**: ランダム移動
    - [x] **NAPPING**: 睡眠カウントダウンと起床
    - [x] **FLIES**: 距離がある場合は2倍移動、罠回避
    - [x] **FLITS**: 47%でランダム移動 (Bat等)
    - [x] **STATIONARY**: 移動しない (Flytrap/Fungi)
    - [x] **AGGRAVATE**: 全モンスター起床、擬態解除
4. **特殊行動**:
    - [x] **CONFUSES (Medusa)**: 攻撃ヒット時に確率で混乱
    - [x] **FLAMES (Dragon)**: 射程7マスの炎攻撃 (AC軽減無視、必中ではない)
    - [x] **SEEKS_GOLD (Leprechaun)**: 金貨への移動優先 (未実装: 盗んで消える処理) 

### 未実装・調整中
- [ ] **SEEKS_GOLD**: 金貨を盗んだ後の逃走ロジック
- [ ] **迷路 (Maze)**: オリジナルRogue準拠の迷路生成

---

## 巻物 (Scroll) 実装状況詳細 (scroll_status_check.md より統合)

### ✅ 完全実装済み (use.c 準拠)
1.  **識別の巻物 (IDENTIFY)**: 全アイテム識別
2.  **テレポートの巻物 (TELEPORT)**: ランダムテレポート
3.  **武器強化の巻物 (ENCH_WEAPON)**: 命中/ダメージ強化、解呪
4.  **防具強化の巻物 (ENCH_ARMOR)**: AC強化、解呪
5.  **防具保護の巻物 (PROTECT_ARMOR)**: 錆び防止、解呪
6.  **呪い解除の巻物 (REMOVE_CURSE)**: 全アイテム解呪
7.  **睡眠の巻物 (SLEEP)**: プレイヤー睡眠状態 (4-8ターン)
8.  **地図作成の巻物 (MAGIC_MAPPING)**: 全マップ公開
9.  **怪物恐怖の巻物 (SCARE_MONSTER)**: 読むとメッセージのみ（本来は足元に置くと効果あり）
10. **怪物召喚の巻物 (CREATE_MONSTER)**: プレイヤー周囲にモンスター生成
11. **金縛りの巻物 (HOLD_MONSTER)**: 周囲2マスのモンスターをASLEEP停止
12. **怪物激怒の巻物 (AGGRAVATE_MONSTER)**: 全モンスター起床、擬態解除

---

## 参考資料: オリジナル仕様メモ

### 1. CREATE_MONSTER (怪物召喚)
**オリジナルの処理 (monster.c line 580-616)**:
- プレイヤー周囲9マスをランダムに探索
- 配置可能な場所 (床・通路・階段・ドア) にモンスターを生成
- 生成されたモンスターは即座に起きる (WAKENS)

### 2. HOLD_MONSTER (金縛り)
**オリジナルの処理 (use.c line 637-667)**:
- プレイヤー周囲5x5マス (2マス範囲) のモンスター対象
- フラグ `ASLEEP` を立て、`WAKENS` を解除する (起きなくなる)

### 3. AGGRAVATE_MONSTER (怪物激怒)
**オリジナルの処理 (monster.c line 738-753)**:
- 全モンスターを `wake_up`
- `IMITATES` フラグを解除 (MimicやXerocが正体を現す)
- 視界内のモンスターを再描画

### 4. 探索と隠し要素 (`search.c`)
- [x] 基本的な探索コマンドの実装 (`s` キー)
    - [x] `Level.js` に `search` メソッド実装
    - [x] `Game.js` に `search` コマンド処理追加
- [x] 隠し扉 (`HIDDEN_DOOR`) の実装
    - [x] マップ生成時に確率で隠し扉を作成
    - [x] 探索で発見したら通常の扉 (`+`) に変化
- [x] 隠し通路 (`HIDDEN_PASSAGE`) の実装 - *Level.jsのhiddenObjectsで対応済み*
- [x] 罠の探索 - *TrapManager.searchで実装済み*

### 5. UI/UX 改善
*   [x] ゲーム中デバッグモード（壁無視、全体表示、モンスター全表示）
*   [x] サブメニュー位置調整（インベントリパネルに合わせて配置）
*   [x] 死亡時の確認待ち（メッセージ表示後、Aボタンで墓石へ）
*   [ ] メッセージ履歴のログ表示機能
*   [ ] キーボード操作の完全化（viキーバインドなどの調整）

---

## オリジナルソースコード移植状況 (rogue-reference/src)

| ファイル | 内容 | 状況 | 備考 |
| :--- | :--- | :--- | :--- |
| `monster.c` | モンスターAI | ✅ 完了 | 完全移植 (視界判定 `isLineOfSight` 実装済み) |
| `init.c` | 初期化・生成 | ✅ 完了 | 完全移植 (時間経過湧き `spawnWanderingMonster` 実装済み) |
| `random.c` | 乱数生成 | ✅ 完了 | 完全移植 (`js/random.js` 32bit互換実装) |
| `object.c` | アイテム定義 | ✅ 完了 | 完全移植 |
| `throw.c` | 投擲 | ✅ 完了 | 完全移植 |
| `hit.c` / `fight.c` | 戦闘 | ✅ 完了 | 完全移植 |
| `zap.c` | 杖 | ✅ 完了 | 効果実装済み |
| `pack.c` | インベントリ | ✅ 完了 | スタック処理実装済み |
| `move.c` | 移動 | ✅ 完了 | 完全移植 (`one_move_rogue`, `multiple_move_rogue`, 斜め制限) |
| `play.c` | ゲーム進行 | ✅ 完了 | レベルアップ処理(XPテーブル, HP上昇) 準拠 |
| `use.c` | アイテム効果 | ✅ 完了 | ポーション・巻物全実装 |
| `ring.c` | 指輪 | 🚧 作業中 | 効果計算ロジック連携待ち |
| `trap.c` | 罠 | ✅ 完了 | 基本実装済み |
| `spechit.c` | 特殊攻撃 | ✅ 完了 | 実装済み |
| `save.c` | セーブ | ❌ 未対応 | 不要 |
| `score.c` | スコア | ❌ 未対応 | 簡易実装のみ |
| `search.c` | 探索 | ✅ 完了 | searchコマンド実装済み |

