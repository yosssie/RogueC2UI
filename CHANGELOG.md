# 変更履歴 (CHANGELOG)

このファイルは、Rogue-Web プロジェクトの実装履歴を記録します。

---

## 2026-01-06

### 🎯 trap.c 完全移植
- **罠システム完全実装**
  - `Trap.js` 新規作成
  - 全6種類の罠実装（落とし穴、熊の罠、テレポート、毒ダーツ、睡眠ガス、錆び）
  - 罠配置ロジック（階層別の罠数）
  - 罠発動処理（経験値による回避判定）
  - 探索機能（`s` キー）
  - 罠描画（赤い `^` 記号）

- **統合作業**
  - `Game.js`: `TrapManager` 初期化、罠配置、罠判定
  - `Display.js`: 罠の描画処理
  - `InputManager.js`: `s` キー探索、Aボタン統合（休憩+探索）
  - `style.css`: 罠の色定義

### 💍 ring.c 完全移植
- **指輪システム完全実装**
  - `Ring.js` 新規作成
  - 全11種類の指輪実装
    - 隠密、テレポート（呪い）、再生、遅消化
    - 力増強、力維持、器用さ、装飾
    - 透明視認、防具維持、探索
  - 装備・外す処理（左手・右手）
  - 効果計算（`ring_stats`）
  - ターン毎の効果処理（テレポート呪い、自動探索）
  - 呪われた指輪（外せない）

- **UI統合完了**
  - `Player.js`: 左手・右手の指輪スロット追加
  - `Game.js`: `RingManager` 初期化、ターン毎の効果処理、装備/外すアクション
  - `Item.js`: 指輪定義追加（11種類、未識別名、エンチャント値、呪い判定）
  - `Display.js`: インベントリ表示に `(EL)` `(ER)` マーカー追加
  - サブメニュー: 「装備（左手）」「装備（右手）」「外す」オプション

### 📦 インベントリ上限実装
- **MAX_PACK_COUNT (24個) 実装**
  - `Player.addItem()`: 24個上限チェック追加
  - `Game.movePlayer()`: 満杯時のメッセージ表示
  - 金貨は上限に含まれない（即座に gold に加算）

### 🎮 デバッグレベル再設計
- **3部屋レイアウト**
  - アイテム部屋: 全54種類のアイテムを種類別に配置
  - 罠部屋: 全6種類の罠を配置（見える状態）
  - モンスター部屋: 様々なモンスター
  - 外周通路: ぐるりと回れる通路で全部屋を接続

### 🐛 バグ修正
- **モンスターのドア通過ロジック修正**
  - `Monster.canMoveTo()` に `mon_can_go` ロジック移植
  - 斜め移動でドアを通過できないように修正
  - 縦横移動ならドア通過可能

---

## 2026-01-05 (続き)

### 🐛 重大バグ修正
1. **二重ターン処理バグ（最重要）**
   - `movePlayer` と `handlePlayerAction` の両方で `processTurn` を呼んでいた
   - モンスターが2回行動していたため「逃げても攻撃される」問題が発生
   - `movePlayer` 内の `processTurn` 呼び出しを削除し、`handlePlayerAction` で一元管理

2. **HPがNaNになるバグ**
   - `parseDice` が複数回攻撃記号 (`3d3/2d5`) に対応していなかった
   - スラッシュ以降を無視するように修正

3. **死後攻撃メッセージバグ**
   - プレイヤー死亡後も `forEach` ループが続き、複数の攻撃メッセージが表示
   - `for...of` + `break` に変更し、HP≤0で即座にループ終了

4. **モンスター視界バグ**
   - 部屋内でも隣接モンスターしか表示されない問題
   - `Display.js` の `isInPlayerSight` を拡張し、同じ部屋内なら全て表示
   - **プロパティ名の不一致を修正**: `Level.js` と `DebugLevel.js` が `{width, height}` で保存していたが、`Display.js` は `{w, h}` を期待していた
   - `Game.js` のスポーン処理も同様に修正（モンスター・アイテムが `NaN` 座標に重なっていた）

5. **モンスター重複バグ**
   - 徘徊時に他のモンスターとの衝突判定がなかった
   - `Monster.canMoveTo()` を追加し、他のモンスターがいる位置には移動しないように修正

### 🤖 モンスターAI改善（オリジナルRogue準拠）
- **`mon_sees()` 移植**
  - `monster.c` の `mon_sees()` ロジックを完全移植
  - 同じ部屋内 → 追跡
  - 隣接（8方向） → 追跡
  - それ以外 → 徘徊
  - 壁越し・ドア越しには追いかけてこない

- **斜め移動対応**
  - 従来は縦横のみの移動だったが、斜め移動も可能に
  - オリジナルRogueに近い追跡挙動を実装

### ⚕️ HP自動回復システム実装
- **`move.c` の `heal()` 移植**
  - レベルに応じた回復間隔（Lv1=20ターン、Lv2=18ターン...）
  - 1回の回復でHP+1～2
  - `Player.regenerateHP()` メソッド追加

### 🏃 移動システム拡張
- **`move.c` 主要機能移植**
  - ✅ `rest` - `.` キー / Aボタンで休憩（その場待機）
  - ✅ `dash` - Bボタン+方向キーで走る（簡易版）
  - ✅ `check_hunger` - 空腹判定・餓死処理（既存改善）

- **ダッシュ機能（簡易実装）**
  - Bボタン押しながら方向キーで走る
  - 壁・モンスター・アイテムにぶつかるまで連続移動
  - 各ステップでターン処理（モンスターも動く）

### � 操作改善
- **アイテム自動拾得**
  - `move.c` の `one_move_rogue` を調査
  - オリジナルRogueは全アイテムを自動で拾う仕様と判明
  - 金貨だけでなく全アイテムを自動拾得に変更

- **ボタンマッピング最適化**
  - Aボタン（Enter）: 休憩・探索（search実装予定）
  - Bボタン（X）: ダッシュモディファイア
  - Rボタン（W）: 斜め移動モディファイア

### 🎨 UI改善
- デバッグ表示を右下に移動

---

## 2026-01-05

### �🎯 投擲システムの完全実装
- **投げる処理 (throw.c 移植完了)**
  - 方向指定UI（ターゲットカーソル）実装
  - 軌道計算（最大24歩、壁・モンスター衝突判定）
  - 弓矢ボーナス（Arrow + Bow で命中率・ダメージ増加）
  - 投擲武器ボーナス（Dagger/Shuriken/Dart）
  - アイテム落下処理（`flopWeapon`）
  - 命中時はアイテム消滅、外れ時は地面に落下

### ⚔️ 戦闘システムの本格実装
- **hit.c / fight.c 移植完了**
  - 命中判定（`hit_chance`）実装
    - プレイヤー: `40 + レベル*2 + STR補正 + 武器補正`
    - モンスター: `60 - プレイヤーレベル*2 - AC補正`
  - ダメージ計算（STR/武器/レベルボーナス）
  - `resolveAttack` メソッドで戦闘を一元管理
  - プレイヤー・モンスター双方の攻撃に対応

### 🐛 バグ修正
1. **モンスターシンボル表示バグ**
   - `Display.js` が `monster.char` を参照していたが、正しくは `monster.symbol`
   - 修正により、モンスターが正しく 'A', 'B' 等のアルファベットで表示されるように

### 📋 タスクリスト更新
- `throw.c` を「完了」セクションに移動
- `hit.c / fight.c` を「完了」セクションに移動
- オリジナルRogueソースコードの移植状況を整理

---

## 実装状況サマリー

### ✅ 完全実装（オリジナルRogue準拠）
- `throw.c` - 投擲システム
- `hit.c` / `fight.c` - 戦闘システム
- `move.c` - 移動・HP回復・休憩（ダッシュは簡易版）
- `monster.c` - モンスターAI（`mon_sees`, `mon_can_go`, 移動ロジック）
- `trap.c` - 罠システム（全6種類、配置、発動、探索）
- `ring.c` - 指輪システム（全11種類、装備、効果計算）

### 🔶 簡易実装（動作するが完全ではない）
- `move.c` の `multiple_move_rogue` - ダッシュ（通路自動追従なし）
- `move.c` の `check_hunger` - 空腹処理（指輪効果は実装済み）
- `ring.c` のUI部分 - 指輪装備/外すUIが未実装

### ❌ 未実装
- 杖 (`zap.c`)
- 特殊攻撃 (`spechit.c`)
- セーブ/ロード (`save.c`)
- スコアシステム (`score.c`)

---

## 次回の課題

### 🔧 未実装機能
- 罠 (`trap.c`)
- 杖 (`zap.c`)
- 指輪 (`ring.c`)
- 特殊攻撃 (`spechit.c`)
- セーブ/ロード (`save.c`)
- スコアシステム (`score.c`)

### 🎨 改善予定
- インベントリのスタック機能（矢などをまとめる）
- アイテム効果の完全実装（状態異常など）
- 隠し扉・罠の発見処理
- ダッシュの通路自動追従機能

---

## 開発メモ

### 設計方針
- オリジナルRogue (v5.4) の仕様を可能な限り忠実に再現
- C言語のソースコード (`rogue-reference/src`) を参照しながら移植
- Web技術 (HTML/CSS/JavaScript) で実装
- ターン制ローグライクの基本を守る

### ファイル構成
- `js/game.js` - ゲームロジック全般
- `js/player.js` - プレイヤー管理
- `js/monster.js` - モンスター定義・AI
- `js/item.js` - アイテム定義・効果
- `js/level.js` - ダンジョン生成
- `js/display.js` - 描画管理
- `js/input.js` - 入力管理
- `js/debug-level.js` - デバッグ用固定マップ
