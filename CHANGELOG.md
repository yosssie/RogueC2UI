# 変更履歴 (CHANGELOG)

このファイルは、Rogue-Web プロジェクトの実装履歴を記録します。

---

## 2026-01-13

### 🧱 罠システムの完全化 (オリジナルRogue準拠)
- **落とし穴 (TRAP_DOOR)**: ダメージなしで次の階層へ移動。浮遊時は発動しない仕様を実装
- **熊の罠 (BEAR_TRAP)**: 毎ターン拘束時間が減少するように修正（移動以外の行動は可能に）
- **毒ダーツ (DART_TRAP)**: **力維持の指輪**による毒効果無効化を実装
- **睡眠ガス (SLEEPING_GAS_TRAP)**:
    - ターン経過の実装を一新（`procceTurn`ループから非同期のウェイト処理へ）
    - メッセージ表示とウェイトの順序を最適化し、状況をわかりやすく改善
    - 死亡時に不自然なメッセージ（「目が覚めた」）が出ないように修正
- **テレポート (TELE_TRAP)**: ランダム移動の実装を確認（正常）
- **錆び罠 (RUST_TRAP)**: 特殊攻撃ロジックに統合済み

### 🎪 モンスターハウス (Party Room) 実装完了
- **オリジナルRogueに完全準拠した実装**:
  - `nextParty()`: 10階ごとのブロック（11-20, 21-30...）内でランダムに1回発生
  - `makeParty()`: ランダムな部屋（R_ROOM | R_MAZE）を選択
  - `partyObjects()`: 5-10個（50%で+5-10個）のアイテムを配置、部屋サイズの上限チェック
  - `partyMonsters()`: アイテム数の2倍のモンスターを配置、部屋が満杯になったら早期終了
- **発生条件**:
  - 最速11階、以降10階ごとのブロック内で必ず1回（ゲーム全体で1-2回程度）
  - 帰り道（上り）では発生しない
- **配置ロジック**:
  - 部屋の壁の内側（`left_col+1` ~ `right_col-1`）にランダム配置
  - 250回試行して配置できない場合はスキップ
  - モンスターは全て `WAKENS` フラグ付き（部屋に入ると75%の確率で一斉に起床）
- **バグ修正履歴**:
  - 座標計算: `room.x/y` → `room.left_col/top_row` 使用
  - アイテム生成: `this.level.getRandomItem()` → `new Item()` 使用
  - モンスター生成: `Monster.getRandomMonster()` → `new Monster()` 使用
  - 床判定: `tile.type === 'floor'` → `level.isWalkable()` 使用
  - 処理順序: `makeParty()` を `spawnMonsters()/spawnItems()` の後に呼び出し


### 🤖 モンスター挙動の修正 (オリジナルRogue準拠)
- **部屋出入り時の起床判定**:
  - 部屋に入るときだけでなく、部屋から通路に出るときも `wake_room` (起床判定) を行うように修正
- **初期生成時の起床**:
  - `WANDERS` (徘徨) フラグを持つモンスターは、生成時に50%の確率で起きている状態になるように修正
- **挙動確認（仕様通り）**:
  - `WANDERS` フラグを持たないモンスター（大うずら等）が、ターゲットを見失った後に動かなくなる挙動を確認
  - 氷の怪物(I)などの出現階層がオリジナルRogue設定通りであることを確認


## 2026-01-08

### 🤖 モンスターAI修正
- **追跡ロジック改善**:
  - 部屋に入った際にターゲットを見失う（Wander状態になる）バグを修正（`findExitInRoom`の壁判定を修正）
  - 通路から部屋へ、部屋から通路への追跡がスムーズに行われるように改善
- **生成バグ修正**:
  - 時間経過で湧くモンスターがドア（`+`）の上に生成されないように修正
- **行動仕様修正（オリジナル準拠）**:
  - 寝ているモンスターが隣接判定で起きた直後のターンには攻撃してこないように修正（1ターンの猶予を確保）

### 🔧 デバッグ機能強化
- **AI状態表示**:
  - モンスターの現在のAI状態を文字で表示（`[C]`hase, `[S]`eek, `[W]`ander）

### 🐛 バグ修正
- **食料のバグ修正**: 食料を食べると空腹度が減ってしまうバグを修正。正しく空腹度が回復するように変更（最大値1300）
- **配置バグ修正**: ドア（`+`）の上にアイテムやモンスターが生成されるバグを修正
- **ダンジョン生成改善**: 孤立した部屋が生成される問題を修正。オリジナルRogueの接続アルゴリズム（`i+2`, `i+6`の交差接続）を完全実装

### 🎮 階層移動システム
- **階段処理の実装**: `nextLevel()` メソッドを追加。階段を降りると次の階層へ進めるように
- **状態の引き継ぎ**: プレイヤーのHP、持ち物、経験値などが次の階層に引き継がれる
- **UIからの操作**: インベントリで足元の階段を選択して「降りる」を実行可能

### 📝 メッセージシステム実装（オリジナルRogue完全準拠）
- **mesg_J.js作成**: オリジナルRogueの`mesg_J`ファイルから全493個のメッセージを配列化
- **全ファイル移行完了**: 以下のファイルの全メッセージをmesg_J準拠に統一
  - `Game.js`: 戦闘、移動、拘束、モンスター生成、アイテム取得、投擲メッセージ
  - `Player.js`: 空腹メッセージ（空腹、飢餓、瀕死）
  - `trap.js`: 罠メッセージ（落とし穴、熊の罠、テレポート、毒矢、睡眠ガス、錆び）
  - `ring.js`: 指輪・呪いメッセージ
  - `Item.js`: ポーション、巻物、食料メッセージ
  - `spechit.js`: 特殊攻撃メッセージ（錆び、凍結、毒、生命力吸収、盗み）
- **定数化**: よく使うメッセージは`MesgConst`で定数化して可読性向上

### 📚 拡張機能の調査
- **オリジナル版 vs 拡張版**: `rogue-reference` のソースコードに含まれる拡張機能を調査
- **主な拡張機能**:
  - ポーション投擲（敵に効果）
  - 曲がった通路の自動移動（✅ 既に実装済み）
  - 識別挙動改善（使ったら必ず識別）
  - アイテム配置の調整
- **今後の実装予定**: ポーション投擲、識別改善、バランス調整

### 🍎 アイテム・機能実装（オリジナルRogue準拠）
- **こけもも (Fruit)**:
  - 食料の種類を「食糧 (Ration)」(70%) と「こけもも (Fruit)」(30%) に分割
  - こけももはスタック不可、数え方は「個の」に変更
- **ポーション仕様修正**:
  - 効果時間の微調整（混乱: 12-22T、浮遊: 15-30T、加速: 11-21T）
  - 「透明視」の効果を永続化し、メッセージを「フルーツジュースの味」に変更
  - 「毒」のメッセージを「毒が回った！」（力維持の指輪があっても）に変更
- **杖の仕様修正**:
  - **無効化の杖 (CANCELLATION)**: 状態異常（混乱・睡眠）は解除せず、特殊能力（浮遊・透明・炎・擬態など）のみを無効化するようにオリジナル準拠で修正
  - 締め付け攻撃に対する救済措置（無効化で解放）を実装

### 🧠 モンスターAI強化
- **視界判定の向上**: 通路などで直線視界 (`isLineOfSight`) が通っていれば距離があっても見失わないように修正
- **追跡ロジック改善**: 分岐点で直進を優先するように変更。また、行き止まりに入った場合にランダム移動 (`Wander`) ではなく引き返すように改善

### 🐛 その他バグ修正
- **ターン消費**: 休息・探索時にターンが2重に消費されていたバグを修正
- **階層移動**: 次の階層に進んだ際、透過・探知系のステータスがリセットされずに残っていた問題を修正
- **攻撃判定修正**: モンスターがドアや通路の角越し（斜め）に攻撃してくるバグを修正（移動不可なら攻撃も不可にする）
- **デバッグ機能調整**:
  - ゲームオーバー時にデバッグモードを自動OFFにするように修正
  - 階層移動時にデバッグモード（全マップ表示）が維持されるように修正
  - デバッグ情報表示位置を画面左下に移動
- **ダンジョン生成修正**:
  - 全ての部屋が連結されるように生成ロジックを見直し
  - 部屋がない区画でも通路が交差(CROSS)するように修正し、孤立部屋が発生しないように改善

### 🎨 アイテム表示の改善
- **呪われたアイテム**: 識別済みの呪われたアイテムに `!` マークを追加し、赤色で表示
- **エンチャント値の表示**: 
  - 武器: `（+1，+2）長い剣` （命中補正，ダメージ補正）
  - 防具: `（+2）鋼鉄のよろい` （防御補正）
  - 指輪: `筋力の指輪（+2）` （筋力・器用さの指輪のみ）
  - スタック武器（矢など）: エンチャント値は非表示
- **プラスのエンチャント**: 黄色で表示（`#ffdd44`）
- **色分け**: 呪い（赤）、プラスエンチャント（黄）、通常（緑）

### ⚙️ 生成ロジックとバランス調整
- **モンスター生成**: オリジナル同様、必ず4〜6体のモンスターが生成されるように修正（生成失敗時のリトライロジックを追加）
- **アイテム生成**:
  - 生成数をオリジナル準拠に修正（2〜5個＋α）
  - 出現確率をオリジナル準拠に調整（巻物30%、薬30%、武器10%、防具9%、食料5%、杖4%、指輪3%）
  - 金貨の生成ロジックを分離し、各部屋に46%の確率で生成されるよう修正（額は階層依存）
- **初期装備**:
  - オリジナルRogue準拠に修正
  - 武器: メイス（+1, +1）、弓（+1, +0）、矢（25-35本）
  - 防具: リングメイル（+1）
  - 食料: 1個

### 💅 UI/表示調整
- **インベントリ表示の整列**:
  - 等幅フォントを採用し、表示位置を固定
  - 装備マーク: `E`, `EL`, `ER` (カッコを削除し2文字固定)
  - 呪いマーク: `!` を常に4文字目に表示
  - アイテム名: エンチャント値を後ろに移動し、`(+1, +1)` の形式に変更（半角化）
  - エンチャント値が0の場合は非表示に修正
  - リストのソート順を変更: 武器 > 防具 > 指輪 > 食料 > ... の順に整理

### 👑 エンディング・スコア周辺の強化
- **勝利画面 (Victory Screen)**:
  - オリジナルRogue準拠のアスキーアートバナーを表示
  - アイテム売却リストの実装（所持品の価値に応じてスコア加算）
- **ランキング画面 (Ranking)**:
  - ゲームクリア・死亡時にTop 10ランキングを表示
  - 死亡時は墓石（Tombstone）のアスキーアートを表示
- **UI調整**:
  - 全画面のフォントサイズを `1.2rem` に統一
  - 画面遷移（タイトル、クリア、売却、ランキング）の操作キーを「Aボタン（Zキー）」または「Enter」に統一し、ガイドメッセージも修正
  - インベントリを開いた際、足元アイテムの有無に関わらず常にリストの先頭を選択するように変更
- **不具合修正**:
  - クリア後に再プレイした際、画面描画が崩れる（売却画面から進まない）問題を修正（DOM管理の刷新）
  - ゲームクリア時にデバッグモードが残ってしまう問題を修正（強制OFF）
  - 再プレイ時に前回のメッセージログや罠データが残る問題を修正

### 🐛 デバッグ機能・ゲームバランス調整
- **デバッグ移動機能**:
  - デバッグモード中に `,` キーで上の階へ、`.` キーで下の階へ強制移動できる機能を追加
  - クリア確認や階層テストが容易に
- **イェンダーの魔除け生成修正**:
  - 26階以降、まだ所持していない場合に必ずフロア内に生成されるよう修正
  - オリジナルRogue仕様に準拠
- **アイテム生成ロジック修正**:
  - 階段を上って到達済みの階層に戻った際、アイテムが再生成されないように修正
  - `src/object.c` の `put_objects` 関数における `if (cur_level < max_level) return;` ロジックを実装
  - 帰還時のアイテム稼ぎを防止し、オリジナルRogue v5.4.4の仕様に完全準拠

---

## 2026-01-07

### � モンスター特殊行動の実装
- **ドラゴンの炎攻撃 (FLAMES) 完全実装** (Original Rogue `monster.c flame_broil` 準拠)
  - **エフェクト**: ドラゴンからプレイヤーへの直線上に `~` (チルダ) の軌跡を一瞬(0.05秒)表示
  - **射程**: 7マス以内の直線のみ
  - **ダメージ**: 4d6 (固定) だが、ACにより軽減される仕様を再現
  - **軽減ロジック**: `damage = max(1, damage - AC)` (炎はAC値そのものがダメージ減少値になる)

- **モンスターAIの改善 (視界・追跡ロジック)**
  - **追跡強化**: プレイヤーが視界から消えても、最後に目撃した地点 (`trow`, `tcol`) まで移動してくるように修正
  - **起床判定修正**: 部屋内での移動ごとに起床判定が行われていたのを修正し、「部屋に入った瞬間」と「隣接時」のみ確率判定するように変更。寝ているモンスターの横を通り抜けることが可能に。(オリジナル `wake_room` 準拠)
  - **被ダメージ時の反応**: 攻撃を受けた際に確実に目を覚ます処理を追加 (`takeDamage` 内で `ASLEEP` 解除)
  - **ターゲット更新**: 部屋から出る際、最後にいた場所をモンスターに認識させる処理を追加
- **UI & 操作性の向上**
  - **ダッシュ時の挙動変更**: ダッシュ（Shift移動）またはBボタン移動時、アイテムの上に乗っても拾わずに停止するように変更 (オリジナル `m` コマンド準拠)。メッセージを「〜の上にいる。」に変更。
  - **足元アイテム表示**: インベントリ画面の最下部に、現在足元にあるアイテムや階段を表示するように改善。
  - **メニューからの操作**: 足元のアイテムを選択した際、サブメニューを表示し「拾う」「降りる」等のアクションを実行可能に変更。
  - **インベントリ制限**: 持ち物がいっぱいの時にアイテムを拾えない処理を追加。

### 📄 ドキュメント整理
- **実装状況管理の効率化**
  - `monster_status_check.md` (モンスター), `scroll_status_check.md` (巻物), `wand_status_check.md` (杖), `potion_status_check.md` (薬) を `task_list.md` に全て統合
  - 重複していたチェックリストを削除して一元管理へ移行

### �🗺️ アイテム効果完全実装
- **地図作成の巻物 (Magic Mapping) 実装**
  - `scroll_magic_mapping` の効果を実装
  - `level.revealAll()` を呼び出してマップ全体を表示
  - 使用時に `game.updateDisplay()` で即座に反映

- **アイテム感知の薬 (Detect Objects) 実装**
  - `potion_detect_objects` の効果を実装
  - `player.status.detectObjects` フラグ追加 (250-550ターン持続)
  - `Display.renderDungeon()` で未訪問の場所でもアイテムを表示
  - `Game.updatePlayerStatus()` でターン毎に減少処理
  - 効果中はマップ全体のアイテムが見える

### 💊 ポーション効果完全実装 (use.c 準拠)
- **回復薬 (HEALING / EXTRA_HEALING) の複雑なロジック実装**
  - `potionHeal()` メソッド追加 (use.c line 518-561 移植)
  - 経験値分回復 + HP割合に応じた回復量計算
  - 満タン時は最大HP増加 (通常+1, 大回復+2)
  - 盲目・混乱・幻覚を治癒/軽減

- **ターン数をオリジナルに準拠**
  - 盲目の薬: 250→500-800ターン
  - 幻覚の薬: 250→500-800ターン
  - 加速の薬: 4-10→11-21ターン (奇数)
  - 浮遊の薬: 15-35→15-30ターン


- **副次効果の実装**
  - 毒の薬: 幻覚も治す
  - 透明視認の薬: 盲目も治す
  - 浮遊の薬: 金縛りと罠から解放
  - 筋力増強の薬: ロジック修正 (str++ → maxStr更新)

### 🎮 ポーション画面・ゲーム効果の完全実装
- **盲目 (BLINDNESS) の画面効果**
  - `Display.renderDungeon()` に盲目チェック追加
  - 盲目時はプレイヤーの隣接1マスのみ表示
  - デバッグモード時は無効化

- **幻覚 (HALLUCINATION) の画面効果**
  - モンスターシンボルをランダムな大文字 (A-Z) に変更
  - アイテムシンボルをランダムなアイテム記号に変更
  - use.c hallucinate() を完全移植

- **モンスター感知 (DETECT_MONSTER) の画面効果**
  - `Display.renderDungeon()` に感知チェック追加
  - 感知中は全モンスターを表示 (視界外でも)
  - デバッグモードと同様の処理

- **混乱 (CONFUSION) のゲーム効果**
  - `Game.movePlayer()` に混乱チェック実装済み
  - 移動方向を8方向からランダム選択

- **加速 (HASTE_SELF) のゲーム効果**
  - `Game.handlePlayerAction()` で加速フラグをprocessTurnに渡す
  - `Game.processTurn(skipMonsters)` でモンスター行動をスキップ
  - 加速中はプレイヤーが2回行動、モンスターが1回行動

- **浮遊 (LEVITATION) のゲーム効果**
  - `TrapManager.trapPlayer()` に浮遊チェック追加
  - 浮遊中は全ての罠を無効化

### 📜 巻物効果完全実装 (use.c 準拠)
- **怪物召喚の巻物 (CREATE_MONSTER) 実装**
  - `Game.createMonster()` メソッド追加 (monster.c line 580-616 移植)
  - プレイヤー周囲9マスをランダムに探索
  - 配置可能な場所にランダムモンスター生成
  - WANDERS/WAKENS フラグがあれば起こす
  - 配置できない場合は「遠くで苦悶の叫び声が聞こえた」

- **金縛りの巻物 (HOLD_MONSTER) 改善**
  - 範囲を3マス→5x5マス (2マス範囲) に変更
  - WAKENS フラグ解除を追加
  - メッセージをモンスター数に応じて変更 (0/1/複数)

- **怪物激怒の巻物 (AGGRAVATE_MONSTER) 改善**
  - IMITATES フラグ解除を追加
  - 画面更新を追加

### 🐉 モンスター行動の完全実装
- **速度 (HASTED/SLOWED) の行動回数反映**
  - `Game.processTurn` のループ処理を刷新
  - HASTED: 1ターンに2回行動
  - SLOWED: 2ターンに1回行動 (トグル)

- **状態異常の挙動改善**
  - **混乱 (CONFUSED)**: 行動時に `randomMove()` を呼び、移動可能なマスへ確実にランダム移動するように改善
  - **睡眠 (NAPPING)**: `sleepTurns` のカウントダウン処理を実装 (杖の効果が正しく切れるように)
  - **固定 (STATIONARY)**: 移動処理を行わないように修正 (Venus Flytrap等)
  - **飛行 (FLIES)**: プレイヤーと離れている場合は2回移動し、接近後のターンは攻撃を行わないロジックを実装 (Griffon, Kestrel等)。オリジナルRogueの `mv_mons` 準拠。

### 🔍 探索機能の実装
- **基本機能**: 隠し扉、罠の発見（実装済み）
- **備考**: `s` キーでの探索時、`Level.search` と `TrapManager.search` の両方を行うように `Game.js` を調整。
  - ※ 誤って変更したキー設定 (`KeyI` for Inventory) を元の `KeyS` に復旧しました。

---

## 2026-01-06 (続き)

### 🐛 ゲーム中デバッグモード実装
- **Dキーでデバッグモード切り替え**
  - 壁判定無効化（どこでも移動可能）
  - 全マップ表示（`level.revealAll()`）
  - 全モンスター表示（視界チェックスキップ）
  - デバッグ情報表示（右下）
  - `Game.inGameDebugMode` フラグ追加
  - `Display.renderDungeon()` に `debugMode` パラメータ追加

### 💀 死亡処理改善
- **死亡メッセージ確認待ち実装**
  - 「あなたは死にました...」メッセージ表示後、Aボタン待ち
  - `death_message` 状態追加
  - `InputManager.handleDeathMessageInput()` 実装
  - ユーザーが死因を確認してから墓石画面へ遷移

### 🎨 UI改善
- **サブメニュー位置調整**
  - インベントリパネルの左側に配置
  - 選択中アイテムの高さに合わせて表示
  - `getBoundingClientRect()` で実際のDOM位置を取得
  - 画面サイズ変更に対応（固定位置ではなく相対位置）

### 🐉 モンスター発生システム修正
- **`Monster.getRandomMonster()` 静的メソッド実装**
  - 階層に応じたモンスタータイプをランダム選択
  - `minLevel` / `maxLevel` による出現制御
- **`addFlag` → `setFlag` 修正**
  - メソッド名の不一致を修正
- **発生間隔・確率を元に戻す**
  - デバッグ用設定（30ターン、100%）から本来の設定（120ターン、70%）に復元

### 🔧 デバッグレベル修正
- **`DebugLevel` に不足メソッド追加**
  - `canMove()` - 移動判定（移動可能に）
  - `isLineOfSight()` - 視線チェック
  - `allowsSight()` - 視線透過判定
  - `revealAll()` - 全体表示
  - `placeStairs()` - 階段配置（ダミー）

---

## 2026-01-06

### 🎯 trap.c 完全移植
- **罠システム完全実装**
  - `Trap.js` 新規作成
  - 全6種類の罠実装（落とし穴、熊の罠、テレポート、毒ダーツ、睡眠ガス、錆び）
  - 罠配置ロジック（階層別の罠数）
  - 罠発動処理（経験値による回避判定）
  - 探索機能（`s` キー）
  - 罠描画（赤い `^` 記号）

- **統合作業**
  - `Game.js`: `TrapManager` 初期化、罠配置、罠判定
  - `Display.js`: 罠の描画処理
  - `InputManager.js`: `s` キー探索、Aボタン統合（休憩+探索）
  - `style.css`: 罠の色定義

### 💍 ring.c 完全移植
- **指輪システム完全実装**
  - `Ring.js` 新規作成
  - 全11種類の指輪実装
    - 隠密、テレポート（呪い）、再生、遅消化
    - 力増強、力維持、器用さ、装飾
    - 透明視認、防具維持、探索
  - 装備・外す処理（左手・右手）
  - 効果計算（`ring_stats`）
  - ターン毎の効果処理（テレポート呪い、自動探索）
  - 呪われた指輪（外せない）

- **UI統合完了**
  - `Player.js`: 左手・右手の指輪スロット追加
  - `Game.js`: `RingManager` 初期化、ターン毎の効果処理、装備/外すアクション
  - `Item.js`: 指輪定義追加（11種類、未識別名、エンチャント値、呪い判定）
  - `Display.js`: インベントリ表示に `(EL)` `(ER)` マーカー追加
  - サブメニュー: 「装備（左手）」「装備（右手）」「外す」オプション

### 📦 インベントリ上限実装
- **MAX_PACK_COUNT (24個) 実装**
  - `Player.addItem()`: 24個上限チェック追加
  - `Game.movePlayer()`: 満杯時のメッセージ表示
  - 金貨は上限に含まれない（即座に gold に加算）

### 🎮 デバッグレベル再設計
- **3部屋レイアウト**
  - アイテム部屋: 全54種類のアイテムを種類別に配置
  - 罠部屋: 全6種類の罠を配置（見える状態）
  - モンスター部屋: 様々なモンスター
  - 外周通路: ぐるりと回れる通路で全部屋を接続

### 🐛 バグ修正
- **モンスターのドア通過ロジック修正**
  - `Monster.canMoveTo()` に `mon_can_go` ロジック移植
  - 斜め移動でドアを通過できないように修正
  - 縦横移動ならドア通過可能

---

## 2026-01-05 (続き)

### 🐛 重大バグ修正
1.  **二重ターン処理バグ（最重要）**
    -   `movePlayer` と `handlePlayerAction` の両方で `processTurn` を呼んでいた
    -   モンスターが2回行動していたため「逃げても攻撃される」問題が発生
    -   `movePlayer` 内の `processTurn` 呼び出しを削除し、`handlePlayerAction` で一元管理

2.  **HPがNaNになるバグ**
    -   `parseDice` が複数回攻撃記号 (`3d3/2d5`) に対応していなかった
    -   スラッシュ以降を無視するように修正

3.  **死後攻撃メッセージバグ**
    -   プレイヤー死亡後も `forEach` ループが続き、複数の攻撃メッセージが表示
    -   `for...of` + `break` に変更し、HP≤0で即座にループ終了

4.  **モンスター視界バグ**
    -   部屋内でも隣接モンスターしか表示されない問題
    -   `Display.js` の `isInPlayerSight` を拡張し、同じ部屋内なら全て表示
    -   **プロパティ名の不一致を修正**: `Level.js` と `DebugLevel.js` が `{width, height}` で保存していたが、`Display.js` は `{w, h}` を期待していた
    -   `Game.js` のスポーン処理も同様に修正（モンスター・アイテムが `NaN` 座標に重なっていた）

5.  **モンスター重複バグ**
    -   徘徊時に他のモンスターとの衝突判定がなかった
    -   `Monster.canMoveTo()` を追加し、他のモンスターがいる位置には移動しないように修正

### 🤖 モンスターAI改善（オリジナルRogue準拠）
### Ver 0.2.14 (Monster Special Actions & Damage Fix)
*   **モンスター特殊行動**: Dragonの炎攻撃 (FLAMES) を実装。
    *   距離7マス以内の直線上にいる場合、50%の確率で炎を吐く。
*   **ダメージ計算式変更**: Original Rogue (v5.4.4) 準拠に変更。
    *   物理攻撃: ダメージの (Armor * 3)% を軽減。
    *   炎攻撃: まず Armor値を減算し、その後 (Armor * 3)% を軽減。
*   **視界判定**: Original Rogueの `mon_sees` 関数に準拠。
    *   普通の部屋: 同じ部屋内なら全体が見える
    *   迷路・通路: 隣接しないと見えない

### Ver 0.2.13 (Monster Special Actions - Medusa)
- **`mon_sees()` 移植**
  - `monster.c` の `mon_sees()` ロジックを完全移植
  - 同じ部屋内 → 追跡
  - 隣接（8方向） → 追跡
  - それ以外 → 徘徊
  - 壁越し・ドア越しには追いかけてこない

- **斜め移動対応**
  - 従来は縦横のみの移動だったが、斜め移動も可能に
  - オリジナルRogueに近い追跡挙動を実装

### ⚕️ HP自動回復システム実装
- **`move.c` の `heal()` 移植**
  - レベルに応じた回復間隔（Lv1=20ターン、Lv2=18ターン...）
  - 1回の回復でHP+1～2
  - `Player.regenerateHP()` メソッド追加

### 🏃 移動システム拡張
- **`move.c` 主要機能移植**
  - ✅ `rest` - `.` キー / Aボタンで休憩（その場待機）
  - ✅ `dash` - Bボタン+方向キーで走る（簡易版）
  - ✅ `check_hunger` - 空腹判定・餓死処理（既存改善）

- **ダッシュ機能（簡易実装）**
  - Bボタン押しながら方向キーで走る
  - 壁・モンスター・アイテムにぶつかるまで連続移動
  - 各ステップでターン処理（モンスターも動く）

### � 操作改善
- **アイテム自動拾得**
  - `move.c` の `one_move_rogue` を調査
  - オリジナルRogueは全アイテムを自動で拾う仕様と判明
  - 金貨だけでなく全アイテムを自動拾得に変更

- **ボタンマッピング最適化**
  - Aボタン（Enter）: 休憩・探索（search実装予定）
  - Bボタン（X）: ダッシュモディファイア
  - Rボタン（W）: 斜め移動モディファイア

### 🎨 UI改善
- デバッグ表示を右下に移動

---

## 2026-01-05

### �🎯 投擲システムの完全実装
- **投げる処理 (throw.c 移植完了)**
  - 方向指定UI（ターゲットカーソル）実装
  - 軌道計算（最大24歩、壁・モンスター衝突判定）
  - 弓矢ボーナス（Arrow + Bow で命中率・ダメージ増加）
  - 投擲武器ボーナス（Dagger/Shuriken/Dart）
  - アイテム落下処理（`flopWeapon`）
  - 命中時はアイテム消滅、外れ時は地面に落下

### ⚔️ 戦闘システムの本格実装
- **hit.c / fight.c 移植完了**
  - 命中判定（`hit_chance`）実装
    - プレイヤー: `40 + レベル*2 + STR補正 + 武器補正`
    - モンスター: `60 - プレイヤーレベル*2 - AC補正`
  - ダメージ計算（STR/武器/レベルボーナス）
  - `resolveAttack` メソッドで戦闘を一元管理
  - プレイヤー・モンスター双方の攻撃に対応

### 🐛 バグ修正
1. **モンスターシンボル表示バグ**
   - `Display.js` が `monster.char` を参照していたが、正しくは `monster.symbol`
   - 修正により、モンスターが正しく 'A', 'B' 等のアルファベットで表示されるように

### 📋 タスクリスト更新
- `throw.c` を「完了」セクションに移動
- `hit.c / fight.c` を「完了」セクションに移動
- オリジナルRogueソースコードの移植状況を整理

---

## 実装状況サマリー

### ✅ 完全実装（オリジナルRogue準拠）
- `throw.c` - 投擲システム
- `hit.c` / `fight.c` - 戦闘システム
- `move.c` - 移動・HP回復・休憩（ダッシュは簡易版）
- `monster.c` - モンスターAI（`mon_sees`, `mon_can_go`, 移動ロジック）
- `trap.c` - 罠システム（全6種類、配置、発動、探索）
- `ring.c` - 指輪システム（全11種類、装備、効果計算）

### 🔶 簡易実装（動作するが完全ではない）
- `move.c` の `multiple_move_rogue` - ダッシュ（通路自動追従なし）
- `move.c` の `check_hunger` - 空腹処理（指輪効果は実装済み）
- `ring.c` のUI部分 - 指輪装備/外すUIが未実装

### ❌ 未実装
- 杖 (`zap.c`)
- 特殊攻撃 (`spechit.c`)
- セーブ/ロード (`save.c`)
- スコアシステム (`score.c`)

---

## 次回の課題

### 🔧 未実装機能
- 罠 (`trap.c`)
- 杖 (`zap.c`)
- 指輪 (`ring.c`)
- 特殊攻撃 (`spechit.c`)
- セーブ/ロード (`save.c`)
- スコアシステム (`score.c`)

### 🎨 改善予定
- インベントリのスタック機能（矢などをまとめる）
- アイテム効果の完全実装（状態異常など）
- 隠し扉・罠の発見処理
- ダッシュの通路自動追従機能

---

## 開発メモ

### 設計方針
- オリジナルRogue (v5.4) の仕様を可能な限り忠実に再現
- C言語のソースコード (`rogue-reference/src`) を参照しながら移植
- Web技術 (HTML/CSS/JavaScript) で実装
- ターン制ローグライクの基本を守る

### ファイル構成
- `js/game.js` - ゲームロジック全般
- `js/player.js` - プレイヤー管理
- `js/monster.js` - モンスター定義・AI
- `js/item.js` - アイテム定義・効果
- `js/level.js` - ダンジョン生成
- `js/display.js` - 描画管理
- `js/input.js` - 入力管理
- `js/debug-level.js` - デバッグ用固定マップ
